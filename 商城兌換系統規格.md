# å•†åŸå…Œæ›ç³»çµ± - åŠŸèƒ½è¦æ ¼æ›¸

## ç³»çµ±æ¦‚è¿°

æ“´å……å¹³å®‰ç¬¦æ‰“å¡ç³»çµ±,æ–°å¢åŠŸå¾·å€¼å…Œæ›æ–‡å‰µå‘¨é‚Šå•†å“åŠŸèƒ½ã€‚ä½¿ç”¨è€…å¯ä»¥ç”¨æ‰“å¡ç´¯ç©çš„åŠŸå¾·å€¼å…Œæ›å•†å“,ä¸¦è¿½è¹¤å…Œæ›è¨‚å–®ç‹€æ…‹ã€‚

---

## è³‡æ–™åº«è¨­è¨ˆ

### 1. products (å•†å“è¡¨)

| æ¬„ä½åç¨± | è³‡æ–™å‹åˆ¥ | èªªæ˜ | ç´„æŸ |
|---------|---------|------|------|
| id | VARCHAR(36) | å•†å“ UUID | PRIMARY KEY |
| name | VARCHAR(100) | å•†å“åç¨± | NOT NULL |
| description | TEXT | å•†å“æè¿° | NULL |
| category | VARCHAR(50) | å•†å“åˆ†é¡ | NOT NULL |
| merit_points | INT | æ‰€éœ€åŠŸå¾·å€¼ | NOT NULL |
| stock_quantity | INT | åº«å­˜æ•¸é‡ | DEFAULT 0 |
| image_url | VARCHAR(500) | å•†å“åœ–ç‰‡ç¶²å€ | NULL |
| images | JSON | å¤šå¼µåœ–ç‰‡ (é™£åˆ—) | NULL |
| is_active | BOOLEAN | æ˜¯å¦ä¸Šæ¶ | DEFAULT TRUE |
| is_featured | BOOLEAN | æ˜¯å¦ç²¾é¸å•†å“ | DEFAULT FALSE |
| sort_order | INT | æ’åºé †åº | DEFAULT 0 |
| created_at | DATETIME | å»ºç«‹æ™‚é–“ | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | æ›´æ–°æ™‚é–“ | ON UPDATE CURRENT_TIMESTAMP |

**ç´¢å¼•**:
- PRIMARY KEY: `id`
- INDEX: `category`, `is_active`, `sort_order`
- INDEX: `merit_points` (ç”¨æ–¼åƒ¹æ ¼æ’åº)

**å•†å“åˆ†é¡ç¯„ä¾‹**:
- `charm` - åŠé£¾
- `tshirt` - Tæ¤
- `sticker` - è²¼ç´™
- `bag` - æè¢‹
- `postcard` - æ˜ä¿¡ç‰‡
- `bookmark` - æ›¸ç±¤
- `badge` - å¾½ç« 
- `keychain` - é‘°åŒ™åœˆ

---

### 2. addresses (æ”¶ä»¶åœ°å€è¡¨)

| æ¬„ä½åç¨± | è³‡æ–™å‹åˆ¥ | èªªæ˜ | ç´„æŸ |
|---------|---------|------|------|
| id | VARCHAR(36) | åœ°å€ UUID | PRIMARY KEY |
| user_id | VARCHAR(36) | ä½¿ç”¨è€… ID | FOREIGN KEY â†’ users.id |
| recipient_name | VARCHAR(50) | æ”¶ä»¶äººå§“å | NOT NULL |
| phone | VARCHAR(20) | è¯çµ¡é›»è©± | NOT NULL |
| postal_code | VARCHAR(10) | éƒµéå€è™Ÿ | NULL |
| city | VARCHAR(20) | åŸå¸‚ | NOT NULL |
| district | VARCHAR(20) | å€åŸŸ | NOT NULL |
| address | VARCHAR(200) | è©³ç´°åœ°å€ | NOT NULL |
| is_default | BOOLEAN | æ˜¯å¦ç‚ºé è¨­åœ°å€ | DEFAULT FALSE |
| created_at | DATETIME | å»ºç«‹æ™‚é–“ | DEFAULT CURRENT_TIMESTAMP |
| updated_at | DATETIME | æ›´æ–°æ™‚é–“ | ON UPDATE CURRENT_TIMESTAMP |

**ç´¢å¼•**:
- PRIMARY KEY: `id`
- INDEX: `user_id`, `is_default`
- FOREIGN KEY: `user_id` REFERENCES `users(id)` ON DELETE CASCADE

---

### 3. redemptions (å…Œæ›è¨˜éŒ„è¡¨)

| æ¬„ä½åç¨± | è³‡æ–™å‹åˆ¥ | èªªæ˜ | ç´„æŸ |
|---------|---------|------|------|
| id | VARCHAR(36) | å…Œæ›è¨˜éŒ„ UUID | PRIMARY KEY |
| user_id | VARCHAR(36) | ä½¿ç”¨è€… ID | FOREIGN KEY â†’ users.id |
| product_id | VARCHAR(36) | å•†å“ ID | FOREIGN KEY â†’ products.id |
| quantity | INT | å…Œæ›æ•¸é‡ | NOT NULL, DEFAULT 1 |
| merit_points_used | INT | ä½¿ç”¨çš„åŠŸå¾·å€¼ | NOT NULL |
| status | ENUM | å…Œæ›ç‹€æ…‹ | NOT NULL |
| recipient_name | VARCHAR(50) | æ”¶ä»¶äººå§“å | NOT NULL |
| phone | VARCHAR(20) | è¯çµ¡é›»è©± | NOT NULL |
| postal_code | VARCHAR(10) | éƒµéå€è™Ÿ | NULL |
| city | VARCHAR(20) | åŸå¸‚ | NOT NULL |
| district | VARCHAR(20) | å€åŸŸ | NOT NULL |
| address | VARCHAR(200) | è©³ç´°åœ°å€ | NOT NULL |
| shipping_method | VARCHAR(50) | é…é€æ–¹å¼ | NULL |
| tracking_number | VARCHAR(100) | ç‰©æµç·¨è™Ÿ | NULL |
| notes | TEXT | å‚™è¨» | NULL |
| admin_notes | TEXT | ç®¡ç†å“¡å‚™è¨» | NULL |
| redeemed_at | DATETIME | å…Œæ›æ™‚é–“ | DEFAULT CURRENT_TIMESTAMP |
| processed_at | DATETIME | è™•ç†æ™‚é–“ | NULL |
| shipped_at | DATETIME | å‡ºè²¨æ™‚é–“ | NULL |
| completed_at | DATETIME | å®Œæˆæ™‚é–“ | NULL |
| cancelled_at | DATETIME | å–æ¶ˆæ™‚é–“ | NULL |

**å…Œæ›ç‹€æ…‹ (status)**:
- `pending` - å¾…è™•ç†
- `processing` - è™•ç†ä¸­
- `shipped` - å·²å‡ºè²¨
- `completed` - å·²å®Œæˆ
- `cancelled` - å·²å–æ¶ˆ

**ç´¢å¼•**:
- PRIMARY KEY: `id`
- INDEX: `user_id`, `status`, `redeemed_at`
- FOREIGN KEY: 
  - `user_id` REFERENCES `users(id)` ON DELETE CASCADE
  - `product_id` REFERENCES `products(id)` ON DELETE RESTRICT

---

## API ç«¯é»è¦æ ¼

### ğŸ›ï¸ å•†å“ç›¸é—œ API

#### 1. å–å¾—å•†å“åˆ—è¡¨
```
GET /api/products
```

**èªªæ˜**: å–å¾—æ‰€æœ‰ä¸Šæ¶çš„å•†å“åˆ—è¡¨

**æŸ¥è©¢åƒæ•¸**:
- `page`: é ç¢¼ (é è¨­: 1)
- `per_page`: æ¯é ç­†æ•¸ (é è¨­: 20)
- `category`: å•†å“åˆ†é¡ç¯©é¸ (å¯é¸)
- `sort`: æ’åºæ–¹å¼ (å¯é¸)
  - `newest` - æœ€æ–°ä¸Šæ¶
  - `price_asc` - åŠŸå¾·å€¼ä½åˆ°é«˜
  - `price_desc` - åŠŸå¾·å€¼é«˜åˆ°ä½
  - `popular` - æœ€å—æ­¡è¿

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "products": [
      {
        "id": "uuid",
        "name": "å¹³å®‰ç¬¦åŠé£¾",
        "description": "ç²¾ç·»æ‰‹å·¥å¹³å®‰ç¬¦åŠé£¾,éš¨èº«æ”œå¸¶ä¿å¹³å®‰",
        "category": "charm",
        "merit_points": 100,
        "stock_quantity": 50,
        "image_url": "https://example.com/products/charm1.jpg",
        "images": [
          "https://example.com/products/charm1_1.jpg",
          "https://example.com/products/charm1_2.jpg"
        ],
        "is_featured": true,
        "created_at": "2025-01-15T10:30:00"
      }
    ],
    "pagination": {
      "page": 1,
      "per_page": 20,
      "total": 50,
      "pages": 3
    }
  }
}
```

---

#### 2. å–å¾—å•†å“è©³æƒ…
```
GET /api/products/<product_id>
```

**èªªæ˜**: å–å¾—å–®ä¸€å•†å“çš„è©³ç´°è³‡è¨Š

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "name": "å¹³å®‰ç¬¦åŠé£¾",
    "description": "ç²¾ç·»æ‰‹å·¥å¹³å®‰ç¬¦åŠé£¾...",
    "category": "charm",
    "merit_points": 100,
    "stock_quantity": 50,
    "image_url": "https://example.com/products/charm1.jpg",
    "images": [...],
    "is_active": true,
    "is_featured": true,
    "redemption_count": 150,
    "created_at": "2025-01-15T10:30:00"
  }
}
```

---

#### 3. å–å¾—å•†å“åˆ†é¡åˆ—è¡¨
```
GET /api/products/categories
```

**èªªæ˜**: å–å¾—æ‰€æœ‰å•†å“åˆ†é¡åŠæ•¸é‡

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "category": "charm",
      "name": "åŠé£¾",
      "count": 15
    },
    {
      "category": "tshirt",
      "name": "Tæ¤",
      "count": 8
    }
  ]
}
```

---

### ğŸ“ åœ°å€ç®¡ç† API

#### 4. å–å¾—æˆ‘çš„åœ°å€åˆ—è¡¨
```
GET /api/addresses
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "recipient_name": "ç‹å°æ˜",
      "phone": "0912345678",
      "postal_code": "100",
      "city": "å°åŒ—å¸‚",
      "district": "ä¸­æ­£å€",
      "address": "é‡æ…¶å—è·¯ä¸€æ®µ122è™Ÿ",
      "is_default": true,
      "created_at": "2025-01-15T10:30:00"
    }
  ]
}
```

---

#### 5. æ–°å¢åœ°å€
```
POST /api/addresses
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**è«‹æ±‚åƒæ•¸**:
```json
{
  "recipient_name": "ç‹å°æ˜",
  "phone": "0912345678",
  "postal_code": "100",
  "city": "å°åŒ—å¸‚",
  "district": "ä¸­æ­£å€",
  "address": "é‡æ…¶å—è·¯ä¸€æ®µ122è™Ÿ",
  "is_default": false
}
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "åœ°å€æ–°å¢æˆåŠŸ",
  "data": {
    "id": "uuid",
    "recipient_name": "ç‹å°æ˜",
    ...
  }
}
```

---

#### 6. æ›´æ–°åœ°å€
```
PUT /api/addresses/<address_id>
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**è«‹æ±‚åƒæ•¸**: åŒæ–°å¢åœ°å€

---

#### 7. åˆªé™¤åœ°å€
```
DELETE /api/addresses/<address_id>
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "åœ°å€å·²åˆªé™¤"
}
```

---

#### 8. è¨­å®šé è¨­åœ°å€
```
PUT /api/addresses/<address_id>/set-default
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å·²è¨­å®šç‚ºé è¨­åœ°å€"
}
```

---

### ğŸ å…Œæ›åŠŸèƒ½ API

#### 9. å…Œæ›å•†å“
```
POST /api/redemptions
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**è«‹æ±‚åƒæ•¸**:
```json
{
  "product_id": "uuid",
  "quantity": 1,
  "address_id": "uuid",
  "notes": "è«‹å°å¿ƒåŒ…è£"
}
```

**å•†æ¥­é‚è¼¯**:
1. é©—è­‰å•†å“å­˜åœ¨ä¸”ä¸Šæ¶
2. æª¢æŸ¥åº«å­˜æ˜¯å¦è¶³å¤ 
3. æª¢æŸ¥ä½¿ç”¨è€…åŠŸå¾·å€¼æ˜¯å¦è¶³å¤ 
4. æ‰£é™¤ä½¿ç”¨è€…åŠŸå¾·å€¼
5. æ¸›å°‘å•†å“åº«å­˜
6. å»ºç«‹å…Œæ›è¨˜éŒ„

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å…Œæ›æˆåŠŸ",
  "data": {
    "redemption": {
      "id": "uuid",
      "product": {
        "name": "å¹³å®‰ç¬¦åŠé£¾",
        "image_url": "..."
      },
      "quantity": 1,
      "merit_points_used": 100,
      "status": "pending",
      "redeemed_at": "2025-01-15T10:30:00"
    },
    "remaining_points": 400
  }
}
```

**éŒ¯èª¤å›æ‡‰**:
- `400`: åŠŸå¾·å€¼ä¸è¶³
- `400`: åº«å­˜ä¸è¶³
- `404`: å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶
- `404`: åœ°å€ä¸å­˜åœ¨

---

#### 10. å–å¾—å…Œæ›è¨˜éŒ„
```
GET /api/redemptions
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**æŸ¥è©¢åƒæ•¸**:
- `page`: é ç¢¼ (é è¨­: 1)
- `per_page`: æ¯é ç­†æ•¸ (é è¨­: 20)
- `status`: ç‹€æ…‹ç¯©é¸ (å¯é¸)

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "redemptions": [
      {
        "id": "uuid",
        "product": {
          "id": "uuid",
          "name": "å¹³å®‰ç¬¦åŠé£¾",
          "image_url": "...",
          "category": "charm"
        },
        "quantity": 1,
        "merit_points_used": 100,
        "status": "shipped",
        "recipient_name": "ç‹å°æ˜",
        "phone": "0912345678",
        "address": "å°åŒ—å¸‚ä¸­æ­£å€é‡æ…¶å—è·¯ä¸€æ®µ122è™Ÿ",
        "tracking_number": "1234567890",
        "redeemed_at": "2025-01-15T10:30:00",
        "shipped_at": "2025-01-16T14:20:00"
      }
    ],
    "pagination": {
      "page": 1,
      "per_page": 20,
      "total": 10,
      "pages": 1
    }
  }
}
```

---

#### 11. å–å¾—å…Œæ›è©³æƒ…
```
GET /api/redemptions/<redemption_id>
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "product": {
      "id": "uuid",
      "name": "å¹³å®‰ç¬¦åŠé£¾",
      "description": "...",
      "image_url": "...",
      "category": "charm"
    },
    "quantity": 1,
    "merit_points_used": 100,
    "status": "shipped",
    "recipient_name": "ç‹å°æ˜",
    "phone": "0912345678",
    "postal_code": "100",
    "city": "å°åŒ—å¸‚",
    "district": "ä¸­æ­£å€",
    "address": "é‡æ…¶å—è·¯ä¸€æ®µ122è™Ÿ",
    "shipping_method": "å®…é…",
    "tracking_number": "1234567890",
    "notes": "è«‹å°å¿ƒåŒ…è£",
    "redeemed_at": "2025-01-15T10:30:00",
    "processed_at": "2025-01-15T15:00:00",
    "shipped_at": "2025-01-16T14:20:00",
    "timeline": [
      {
        "status": "pending",
        "timestamp": "2025-01-15T10:30:00",
        "description": "å…Œæ›ç”³è«‹å·²é€å‡º"
      },
      {
        "status": "processing",
        "timestamp": "2025-01-15T15:00:00",
        "description": "å•†å“æº–å‚™ä¸­"
      },
      {
        "status": "shipped",
        "timestamp": "2025-01-16T14:20:00",
        "description": "å•†å“å·²å‡ºè²¨"
      }
    ]
  }
}
```

---

#### 12. å–æ¶ˆå…Œæ›
```
POST /api/redemptions/<redemption_id>/cancel
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**èªªæ˜**: åªèƒ½å–æ¶ˆã€Œå¾…è™•ç†ã€ç‹€æ…‹çš„å…Œæ›

**å•†æ¥­é‚è¼¯**:
1. æª¢æŸ¥å…Œæ›ç‹€æ…‹æ˜¯å¦ç‚º pending
2. é€€é‚„åŠŸå¾·å€¼çµ¦ä½¿ç”¨è€…
3. æ¢å¾©å•†å“åº«å­˜
4. æ›´æ–°å…Œæ›ç‹€æ…‹ç‚º cancelled

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "message": "å…Œæ›å·²å–æ¶ˆ,åŠŸå¾·å€¼å·²é€€é‚„",
  "data": {
    "refunded_points": 100,
    "current_points": 500
  }
}
```

**éŒ¯èª¤å›æ‡‰**:
- `400`: æ­¤å…Œæ›ç„¡æ³•å–æ¶ˆ(å·²è™•ç†æˆ–å·²å‡ºè²¨)

---

#### 13. å–å¾—å…Œæ›çµ±è¨ˆ
```
GET /api/redemptions/stats
```

**èªè­‰**: éœ€è¦ (Bearer Token)

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "total_redemptions": 15,
    "total_points_used": 1500,
    "status_count": {
      "pending": 2,
      "processing": 1,
      "shipped": 3,
      "completed": 8,
      "cancelled": 1
    },
    "recent_redemptions": [
      {
        "id": "uuid",
        "product_name": "å¹³å®‰ç¬¦åŠé£¾",
        "merit_points_used": 100,
        "status": "shipped",
        "redeemed_at": "2025-01-15T10:30:00"
      }
    ]
  }
}
```

---

### ğŸ”§ ç®¡ç†å“¡ API

#### 14. æ–°å¢å•†å“
```
POST /api/admin/products
```

**èªè­‰**: éœ€è¦ (Bearer Token + ç®¡ç†å“¡æ¬Šé™)

**è«‹æ±‚åƒæ•¸**:
```json
{
  "name": "å¹³å®‰ç¬¦åŠé£¾",
  "description": "ç²¾ç·»æ‰‹å·¥å¹³å®‰ç¬¦åŠé£¾",
  "category": "charm",
  "merit_points": 100,
  "stock_quantity": 50,
  "image_url": "https://example.com/products/charm1.jpg",
  "images": ["url1", "url2"],
  "is_featured": true
}
```

---

#### 15. æ›´æ–°å•†å“
```
PUT /api/admin/products/<product_id>
```

**èªè­‰**: éœ€è¦ (Bearer Token + ç®¡ç†å“¡æ¬Šé™)

---

#### 16. åˆªé™¤å•†å“ (ä¸‹æ¶)
```
DELETE /api/admin/products/<product_id>
```

**èªè­‰**: éœ€è¦ (Bearer Token + ç®¡ç†å“¡æ¬Šé™)

---

#### 17. å–å¾—æ‰€æœ‰å…Œæ›è¨˜éŒ„
```
GET /api/admin/redemptions
```

**èªè­‰**: éœ€è¦ (Bearer Token + ç®¡ç†å“¡æ¬Šé™)

**æŸ¥è©¢åƒæ•¸**:
- `page`, `per_page`: åˆ†é 
- `status`: ç‹€æ…‹ç¯©é¸
- `user_id`: ä½¿ç”¨è€…ç¯©é¸
- `start_date`, `end_date`: æ—¥æœŸç¯„åœ

---

#### 18. æ›´æ–°å…Œæ›ç‹€æ…‹
```
PUT /api/admin/redemptions/<redemption_id>/status
```

**èªè­‰**: éœ€è¦ (Bearer Token + ç®¡ç†å“¡æ¬Šé™)

**è«‹æ±‚åƒæ•¸**:
```json
{
  "status": "shipped",
  "tracking_number": "1234567890",
  "shipping_method": "å®…é…",
  "admin_notes": "å·²æ–¼ä»Šæ—¥å‡ºè²¨"
}
```

---

## è³‡æ–™åº« SQL è…³æœ¬

### å»ºç«‹è³‡æ–™è¡¨

```sql
-- ============================================================================
-- å•†å“è¡¨
-- ============================================================================
CREATE TABLE products (
    id VARCHAR(36) PRIMARY KEY COMMENT 'å•†å“ UUID',
    name VARCHAR(100) NOT NULL COMMENT 'å•†å“åç¨±',
    description TEXT COMMENT 'å•†å“æè¿°',
    category VARCHAR(50) NOT NULL COMMENT 'å•†å“åˆ†é¡',
    merit_points INT NOT NULL COMMENT 'æ‰€éœ€åŠŸå¾·å€¼',
    stock_quantity INT DEFAULT 0 COMMENT 'åº«å­˜æ•¸é‡',
    image_url VARCHAR(500) COMMENT 'å•†å“åœ–ç‰‡ç¶²å€',
    images JSON COMMENT 'å¤šå¼µåœ–ç‰‡',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦ä¸Šæ¶',
    is_featured BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç²¾é¸å•†å“',
    sort_order INT DEFAULT 0 COMMENT 'æ’åºé †åº',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å»ºç«‹æ™‚é–“',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    
    INDEX idx_category (category),
    INDEX idx_is_active (is_active),
    INDEX idx_merit_points (merit_points),
    INDEX idx_sort_order (sort_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å•†å“è¡¨';

-- ============================================================================
-- æ”¶ä»¶åœ°å€è¡¨
-- ============================================================================
CREATE TABLE addresses (
    id VARCHAR(36) PRIMARY KEY COMMENT 'åœ°å€ UUID',
    user_id VARCHAR(36) NOT NULL COMMENT 'ä½¿ç”¨è€… ID',
    recipient_name VARCHAR(50) NOT NULL COMMENT 'æ”¶ä»¶äººå§“å',
    phone VARCHAR(20) NOT NULL COMMENT 'è¯çµ¡é›»è©±',
    postal_code VARCHAR(10) COMMENT 'éƒµéå€è™Ÿ',
    city VARCHAR(20) NOT NULL COMMENT 'åŸå¸‚',
    district VARCHAR(20) NOT NULL COMMENT 'å€åŸŸ',
    address VARCHAR(200) NOT NULL COMMENT 'è©³ç´°åœ°å€',
    is_default BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç‚ºé è¨­åœ°å€',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å»ºç«‹æ™‚é–“',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ™‚é–“',
    
    INDEX idx_user_id (user_id),
    INDEX idx_is_default (is_default),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ”¶ä»¶åœ°å€è¡¨';

-- ============================================================================
-- å…Œæ›è¨˜éŒ„è¡¨
-- ============================================================================
CREATE TABLE redemptions (
    id VARCHAR(36) PRIMARY KEY COMMENT 'å…Œæ›è¨˜éŒ„ UUID',
    user_id VARCHAR(36) NOT NULL COMMENT 'ä½¿ç”¨è€… ID',
    product_id VARCHAR(36) NOT NULL COMMENT 'å•†å“ ID',
    quantity INT NOT NULL DEFAULT 1 COMMENT 'å…Œæ›æ•¸é‡',
    merit_points_used INT NOT NULL COMMENT 'ä½¿ç”¨çš„åŠŸå¾·å€¼',
    status ENUM('pending', 'processing', 'shipped', 'completed', 'cancelled') NOT NULL DEFAULT 'pending' COMMENT 'å…Œæ›ç‹€æ…‹',
    recipient_name VARCHAR(50) NOT NULL COMMENT 'æ”¶ä»¶äººå§“å',
    phone VARCHAR(20) NOT NULL COMMENT 'è¯çµ¡é›»è©±',
    postal_code VARCHAR(10) COMMENT 'éƒµéå€è™Ÿ',
    city VARCHAR(20) NOT NULL COMMENT 'åŸå¸‚',
    district VARCHAR(20) NOT NULL COMMENT 'å€åŸŸ',
    address VARCHAR(200) NOT NULL COMMENT 'è©³ç´°åœ°å€',
    shipping_method VARCHAR(50) COMMENT 'é…é€æ–¹å¼',
    tracking_number VARCHAR(100) COMMENT 'ç‰©æµç·¨è™Ÿ',
    notes TEXT COMMENT 'å‚™è¨»',
    admin_notes TEXT COMMENT 'ç®¡ç†å“¡å‚™è¨»',
    redeemed_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'å…Œæ›æ™‚é–“',
    processed_at DATETIME COMMENT 'è™•ç†æ™‚é–“',
    shipped_at DATETIME COMMENT 'å‡ºè²¨æ™‚é–“',
    completed_at DATETIME COMMENT 'å®Œæˆæ™‚é–“',
    cancelled_at DATETIME COMMENT 'å–æ¶ˆæ™‚é–“',
    
    INDEX idx_user_id (user_id),
    INDEX idx_product_id (product_id),
    INDEX idx_status (status),
    INDEX idx_redeemed_at (redeemed_at),
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å…Œæ›è¨˜éŒ„è¡¨';
```

---

### æ¸¬è©¦è³‡æ–™

```sql
-- æ’å…¥æ¸¬è©¦å•†å“
INSERT INTO products (id, name, description, category, merit_points, stock_quantity, image_url, is_active, is_featured) VALUES
('prod-0001', 'å¹³å®‰ç¬¦åŠé£¾', 'ç²¾ç·»æ‰‹å·¥å¹³å®‰ç¬¦åŠé£¾,éš¨èº«æ”œå¸¶ä¿å¹³å®‰', 'charm', 100, 50, 'https://example.com/charm1.jpg', TRUE, TRUE),
('prod-0002', 'ç¥ˆç¦Tæ¤', '100%ç´”æ£‰ç¥ˆç¦Tæ¤,èˆ’é©åˆæœ‰å‹', 'tshirt', 300, 30, 'https://example.com/tshirt1.jpg', TRUE, FALSE),
('prod-0003', 'å»Ÿå®‡è²¼ç´™çµ„', 'ç²¾ç¾å»Ÿå®‡è²¼ç´™çµ„åˆåŒ…(5å…¥)', 'sticker', 50, 100, 'https://example.com/sticker1.jpg', TRUE, TRUE),
('prod-0004', 'å¹³å®‰å¸†å¸ƒè¢‹', 'ç’°ä¿å¸†å¸ƒæè¢‹,å°æœ‰ç¥ˆç¦åœ–é¨°', 'bag', 200, 40, 'https://example.com/bag1.jpg', TRUE, FALSE),
('prod-0005', 'å»Ÿå®‡æ˜ä¿¡ç‰‡çµ„', 'ç²¾é¸å°ç£è‘—åå»Ÿå®‡æ˜ä¿¡ç‰‡(10å…¥)', 'postcard', 80, 60, 'https://example.com/postcard1.jpg', TRUE, FALSE),
('prod-0006', 'ç¥ˆç¦æ›¸ç±¤', 'é‡‘å±¬æè³ªç¥ˆç¦æ›¸ç±¤', 'bookmark', 60, 80, 'https://example.com/bookmark1.jpg', TRUE, FALSE),
('prod-0007', 'å¹³å®‰å¾½ç« ', 'å¯æ„›å¹³å®‰ç¬¦é€ å‹å¾½ç« ', 'badge', 70, 90, 'https://example.com/badge1.jpg', TRUE, TRUE),
('prod-0008', 'å»Ÿå®‡é‘°åŒ™åœˆ', 'é‡‘å±¬é‘°åŒ™åœˆé™„å¹³å®‰ç¬¦åŠé£¾', 'keychain', 90, 70, 'https://example.com/keychain1.jpg', TRUE, FALSE);

-- æ’å…¥æ¸¬è©¦åœ°å€
INSERT INTO addresses (id, user_id, recipient_name, phone, postal_code, city, district, address, is_default) VALUES
('addr-0001', '550e8400-e29b-41d4-a716-446655440001', 'ç‹å°æ˜', '0912345678', '100', 'å°åŒ—å¸‚', 'ä¸­æ­£å€', 'é‡æ…¶å—è·¯ä¸€æ®µ122è™Ÿ', TRUE),
('addr-0002', '550e8400-e29b-41d4-a716-446655440003', 'æå¤§è¯', '0923456789', '220', 'æ–°åŒ—å¸‚', 'æ¿æ©‹å€', 'ç¸£æ°‘å¤§é“äºŒæ®µ7è™Ÿ', TRUE);
```

---

### è§¸ç™¼å™¨

```sql
-- å…Œæ›å¾Œè‡ªå‹•æ‰£é™¤åŠŸå¾·å€¼å’Œåº«å­˜
DELIMITER //

CREATE TRIGGER after_redemption_insert
AFTER INSERT ON redemptions
FOR EACH ROW
BEGIN
    -- æ‰£é™¤ä½¿ç”¨è€…åŠŸå¾·å€¼
    UPDATE users 
    SET blessing_points = blessing_points - NEW.merit_points_used
    WHERE id = NEW.user_id;
    
    -- æ¸›å°‘å•†å“åº«å­˜
    UPDATE products 
    SET stock_quantity = stock_quantity - NEW.quantity
    WHERE id = NEW.product_id;
END//

DELIMITER ;

-- å–æ¶ˆå…Œæ›å¾Œé€€é‚„åŠŸå¾·å€¼å’Œåº«å­˜
DELIMITER //

CREATE TRIGGER after_redemption_cancelled
AFTER UPDATE ON redemptions
FOR EACH ROW
BEGIN
    IF NEW.status = 'cancelled' AND OLD.status != 'cancelled' THEN
        -- é€€é‚„åŠŸå¾·å€¼
        UPDATE users 
        SET blessing_points = blessing_points + NEW.merit_points_used
        WHERE id = NEW.user_id;
        
        -- æ¢å¾©åº«å­˜
        UPDATE products 
        SET stock_quantity = stock_quantity + NEW.quantity
        WHERE id = NEW.product_id;
    END IF;
END//

DELIMITER ;
```

---

### çµ±è¨ˆè¦–åœ–

```sql
-- å•†å“å…Œæ›çµ±è¨ˆè¦–åœ–
CREATE OR REPLACE VIEW v_product_redemption_stats AS
SELECT 
    p.id,
    p.name,
    p.category,
    p.merit_points,
    p.stock_quantity,
    COUNT(r.id) as redemption_count,
    SUM(r.quantity) as total_quantity_redeemed,
    SUM(r.merit_points_used) as total_points_used
FROM products p
LEFT JOIN redemptions r ON p.id = r.product_id AND r.status != 'cancelled'
WHERE p.is_active = TRUE
GROUP BY p.id, p.name, p.category, p.merit_points, p.stock_quantity;

-- ä½¿ç”¨è€…å…Œæ›çµ±è¨ˆè¦–åœ–
CREATE OR REPLACE VIEW v_user_redemption_stats AS
SELECT 
    u.id,
    u.username,
    COUNT(r.id) as total_redemptions,
    SUM(r.merit_points_used) as total_points_used,
    COUNT(CASE WHEN r.status = 'pending' THEN 1 END) as pending_count,
    COUNT(CASE WHEN r.status = 'processing' THEN 1 END) as processing_count,
    COUNT(CASE WHEN r.status = 'shipped' THEN 1 END) as shipped_count,
    COUNT(CASE WHEN r.status = 'completed' THEN 1 END) as completed_count
FROM users u
LEFT JOIN redemptions r ON u.id = r.user_id
GROUP BY u.id, u.username;
```

---

## å‰ç«¯æ•´åˆç¯„ä¾‹

### JavaScript/Fetch ç¯„ä¾‹

```javascript
// 1. å–å¾—å•†å“åˆ—è¡¨
async function getProducts(category = null, page = 1) {
  const url = category 
    ? `http://localhost:5000/api/products?category=${category}&page=${page}`
    : `http://localhost:5000/api/products?page=${page}`;
  
  const response = await fetch(url);
  const data = await response.json();
  return data.data.products;
}

// 2. å…Œæ›å•†å“
async function redeemProduct(productId, addressId, quantity = 1, notes = '') {
  const token = localStorage.getItem('access_token');
  
  const response = await fetch('http://localhost:5000/api/redemptions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({
      product_id: productId,
      address_id: addressId,
      quantity: quantity,
      notes: notes
    })
  });
  
  const data = await response.json();
  
  if (data.success) {
    alert('å…Œæ›æˆåŠŸ!');
    return data.data;
  } else {
    alert('å…Œæ›å¤±æ•—: ' + data.message);
    return null;
  }
}

// 3. æ–°å¢æ”¶ä»¶åœ°å€
async function addAddress(addressData) {
  const token = localStorage.getItem('access_token');
  
  const response = await fetch('http://localhost:5000/api/addresses', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(addressData)
  });
  
  return await response.json();
}

// 4. å–å¾—æˆ‘çš„å…Œæ›è¨˜éŒ„
async function getMyRedemptions(status = null) {
  const token = localStorage.getItem('access_token');
  const url = status 
    ? `http://localhost:5000/api/redemptions?status=${status}`
    : 'http://localhost:5000/api/redemptions';
  
  const response = await fetch(url, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  const data = await response.json();
  return data.data.redemptions;
}

// 5. å–æ¶ˆå…Œæ›
async function cancelRedemption(redemptionId) {
  const token = localStorage.getItem('access_token');
  
  const response = await fetch(
    `http://localhost:5000/api/redemptions/${redemptionId}/cancel`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    }
  );
  
  return await response.json();
}
```

---

## æ¥­å‹™è¦å‰‡

### å…Œæ›è¦å‰‡
1. ä½¿ç”¨è€…åŠŸå¾·å€¼å¿…é ˆè¶³å¤ æ‰èƒ½å…Œæ›
2. å•†å“åº«å­˜å¿…é ˆè¶³å¤ æ‰èƒ½å…Œæ›
3. æ¯æ¬¡å…Œæ›æœƒç«‹å³æ‰£é™¤åŠŸå¾·å€¼å’Œåº«å­˜
4. åªæœ‰ã€Œå¾…è™•ç†ã€ç‹€æ…‹çš„å…Œæ›å¯ä»¥å–æ¶ˆ
5. å–æ¶ˆå…Œæ›æœƒé€€é‚„åŠŸå¾·å€¼å’Œæ¢å¾©åº«å­˜

### ç‹€æ…‹æµç¨‹
```
pending (å¾…è™•ç†)
    â†“
processing (è™•ç†ä¸­)
    â†“
shipped (å·²å‡ºè²¨)
    â†“
completed (å·²å®Œæˆ)

å¯åœ¨ä»»ä½•éšæ®µ â†’ cancelled (å·²å–æ¶ˆï¼Œä½†åªæœ‰ pending å¯ç”±ä½¿ç”¨è€…å–æ¶ˆ)
```

### åº«å­˜ç®¡ç†
- å…Œæ›æ™‚ç«‹å³æ‰£é™¤åº«å­˜
- å–æ¶ˆå…Œæ›æ™‚æ¢å¾©åº«å­˜
- åº«å­˜ç‚º 0 æ™‚ä¸å¯å…Œæ›
- ç®¡ç†å“¡å¯ä»¥èª¿æ•´åº«å­˜æ•¸é‡

---

## å®‰å…¨æ€§è€ƒé‡

1. **æ¬Šé™æ§åˆ¶**
   - å…Œæ›åŠŸèƒ½éœ€è¦ç™»å…¥
   - åªèƒ½æŸ¥çœ‹/å–æ¶ˆè‡ªå·±çš„å…Œæ›è¨˜éŒ„
   - ç®¡ç†å“¡æ‰èƒ½ç®¡ç†å•†å“å’Œæ‰€æœ‰å…Œæ›è¨˜éŒ„

2. **è³‡æ–™é©—è­‰**
   - é©—è­‰åŠŸå¾·å€¼æ˜¯å¦è¶³å¤ 
   - é©—è­‰åº«å­˜æ˜¯å¦è¶³å¤ 
   - é©—è­‰åœ°å€æ˜¯å¦å±¬æ–¼ç•¶å‰ä½¿ç”¨è€…

3. **äº¤æ˜“å®‰å…¨**
   - ä½¿ç”¨è³‡æ–™åº« transaction ç¢ºä¿åŠŸå¾·å€¼æ‰£é™¤å’Œåº«å­˜æ¸›å°‘çš„åŸå­æ€§
   - ä½¿ç”¨è§¸ç™¼å™¨è‡ªå‹•è™•ç†åŠŸå¾·å€¼å’Œåº«å­˜è®Šæ›´

---

## æœªä¾†æ“´å……å»ºè­°

1. **å„ªæƒ æ´»å‹•**: ç‰¹å®šæ™‚é–“å•†å“æ‰“æŠ˜(åŠŸå¾·å€¼æŠ˜æ‰£)
2. **é™é‡å•†å“**: è¨­å®šå•†å“çš„é–‹å§‹/çµæŸæ™‚é–“
3. **å•†å“è©•åƒ¹**: å…Œæ›å¾Œå¯ä»¥è©•åˆ†å’Œç•™è¨€
4. **é¡˜æœ›æ¸…å–®**: ä½¿ç”¨è€…å¯ä»¥æ”¶è—æƒ³å…Œæ›çš„å•†å“
5. **å…Œæ›é€šçŸ¥**: ç‹€æ…‹è®Šæ›´æ™‚ç™¼é€é€šçŸ¥(Email/æ¨æ’­)
6. **ç©åˆ†ç­‰ç´š**: æ ¹æ“šåŠŸå¾·å€¼è¨­å®šæœƒå“¡ç­‰ç´š,äº«æœ‰ä¸åŒæŠ˜æ‰£
7. **æ¨è–¦ç³»çµ±**: æ ¹æ“šä½¿ç”¨è€…æ‰“å¡è¨˜éŒ„æ¨è–¦é©åˆçš„å•†å“

---

**ç‰ˆæœ¬**: 1.0.0  
**æœ€å¾Œæ›´æ–°**: 2025-01-15
